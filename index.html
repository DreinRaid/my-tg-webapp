<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ --- */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #b0b0b0);
            --tg-link: var(--tg-theme-link-color, #8774e1);
            --tg-button: var(--tg-theme-button-color, #6462e7);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
            --green-color: #34C759;
            --red-color: #FF3B30;
            --yellow-color: #FFCC00;
            --gray-color: #8E8E93;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            color: var(--tg-text);
            background-color: var(--tg-bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ --- */
        .card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .card-header {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .card-header .emoji {
            font-size: 24px;
            margin-right: 10px;
        }

        /* --- –°–ø–∏—Å–∫–∏ --- */
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-bg);
        }
        .item:last-child {
            border-bottom: none;
        }
        .item-info {
            flex-grow: 1;
            margin-right: 10px;
        }
        .item-info b {
            font-size: 16px;
            display: block;
        }
        .item-info small {
            color: var(--tg-hint);
            display: block;
            font-size: 13px;
        }

        /* --- –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã --- */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-button-text);
            background-color: var(--tg-button);
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.1s ease;
        }
        button:active {
            transform: scale(0.98);
        }
        .action-button {
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
            margin-left: 5px;
            background-color: var(--tg-hint);
            color: var(--tg-bg);
        }
        .action-button.danger {
             background-color: var(--red-color);
             color: white;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: var(--tg-bg);
            color: var(--tg-text);
            box-sizing: border-box;
            font-size: 16px;
        }

        /* --- –°—Ç–∞—Ç—É—Å—ã --- */
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .status-valid { background-color: var(--green-color); color: white; }
        .status-invalid { background-color: var(--red-color); color: white; }
        .status-checking { background-color: var(--yellow-color); color: black; }
        .status-unknown { background-color: var(--gray-color); color: white; }

        .placeholder {
            text-align: center;
            padding: 20px;
            color: var(--tg-hint);
        }
    </style>
</head>
<body>

    <main>
        <div class="card">
            <div class="card-header">
                <span class="emoji">üëã</span>
                <span id="greeting">–ü—Ä–∏–≤–µ—Ç!</span>
            </div>
            <p style="color: var(--tg-hint); font-size: 14px; margin: 0;">–≠—Ç–æ —Ç–≤–æ—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.</p>
        </div>

        <div class="card">
            <div class="card-header"><span class="emoji">üì±</span> –ê–∫–∫–∞—É–Ω—Ç—ã (<span id="accounts-count">0</span>)</div>
            <div id="accounts-list" class="item-list">
                <div class="placeholder">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏ –∏—Ö –∏–∑ –±–æ—Ç–∞.</div>
            </div>
        </div>

        <div class="card">
             <div class="card-header"><span class="emoji">üåê</span> –ü—Ä–æ–∫—Å–∏ (<span id="proxies-count">0</span>)</div>
             <div id="proxies-list" class="item-list">
                <div class="placeholder">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
             </div>
             <footer style="margin-top: 15px;">
                <input type="text" id="proxy-input" placeholder="socks5://user:pass@host:port">
                <button onclick="addProxy()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∫—Å–∏</button>
             </footer>
        </div>

        <div class="card">
            <div class="card-header"><span class="emoji">üöÄ</span> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
            <button onclick="requestDataFromBot()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <button onclick="startBroadcast()">–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
        </div>
    </main>

    <script>
        // --- –í–µ—Å—å JavaScript –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
        // –Ø –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –µ–≥–æ —Å—é–¥–∞. –ú–µ–Ω—è—Ç—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ.
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const API_BASE_URL = "https://your-ngrok-or-server-url";
        const USER_ID = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'test_user';

        let state = {};

        async function api(endpoint, method = 'GET', body = null) {
            const url = `${API_BASE_URL}/api/${endpoint}`;
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            return response.json();
        }

        async function fetchState() {
            try {
                const data = await api(`get_state/${USER_ID}`);
                state = data;
                render();
            } catch (e) {
                tg.showAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${e.message}`);
            }
        }

        async function addProxy() {
            const input = document.getElementById('proxy-input');
            if (!input.value) return;
            try {
                await api('add_proxy', 'POST', { user_id: USER_ID, url: input.value });
                input.value = '';
                await fetchState();
            } catch (e) {
                tg.showAlert(`–û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        async function assignProxy(accountId, proxyId) {
            try {
                 await api('assign_proxy', 'POST', { user_id: USER_ID, account_id: accountId, proxy_id: parseInt(proxyId) });
                 tg.HapticFeedback.notificationOccurred('success');
                 // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                 await fetchState();
            } catch(e) {
                tg.showAlert(`–û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        function startBroadcast() {
            tg.showConfirm("–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –∏—Å—Ç–æ—Ä–∏–π?", (ok) => {
                if(ok) {
                    tg.sendData(JSON.stringify({ command: 'start_broadcast' }));
                    tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
                }
            });
        }

        function requestDataFromBot() {
            fetchState();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function render() {
            document.getElementById('accounts-count').innerText = state.accounts ? state.accounts.length : 0;
            document.getElementById('proxies-count').innerText = state.proxies ? state.proxies.length : 0;

            const accList = document.getElementById('accounts-list');
            accList.innerHTML = '';
            if (!state.accounts || state.accounts.length === 0) {
                accList.innerHTML = '<div class="placeholder">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤.</div>';
            } else {
                state.accounts.forEach(acc => {
                    const [acc_id, session, status, proxy_url] = acc;
                    const div = document.createElement('div');
                    div.className = 'item';

                    let proxyOptions = '<option value="-1">–ë–µ–∑ –ø—Ä–æ–∫—Å–∏</option>' + state.proxies.map(p => {
                        const [p_id, p_url] = p;
                        const isSelected = p_url === proxy_url;
                        return `<option value="${p_id}" ${isSelected ? 'selected' : ''}>–ü—Ä–æ–∫—Å–∏ #${p_id}</option>`;
                    }).join('');

                    div.innerHTML = `
                        <div class="item-info">
                            <b>–ê–∫–∫–∞—É–Ω—Ç #${acc_id} <span class="status status-${status}">${status}</span></b>
                            <small>
                                <select onchange="assignProxy(${acc_id}, this.value)">${proxyOptions}</select>
                            </small>
                        </div>
                    `;
                    accList.appendChild(div);
                });
            }

            const proxyList = document.getElementById('proxies-list');
            proxyList.innerHTML = '';
             if (!state.proxies || state.proxies.length === 0) {
                proxyList.innerHTML = '<div class="placeholder">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏.</div>';
            } else {
                state.proxies.forEach(proxy => {
                    const [proxy_id, proxy_url] = proxy;
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-info" style="text-align: right;"><code>${proxy_url}</code></div>
                    `;
                    proxyList.appendChild(div);
                });
            }
        }

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        document.getElementById('greeting').innerText = `–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!`;
        fetchState();
    </script>
</body>
</html>